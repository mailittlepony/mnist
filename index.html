<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MNIST</title>
        <script src="https://cdn.tailwindcss.com"></script>
      <script type="module" crossorigin>(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=`modulepreload`,t=function(e,t){return new URL(e,t).href},n={};const r=function(r,i,a){let o=Promise.resolve();if(i&&i.length>0){let r=document.getElementsByTagName(`link`),s=document.querySelector(`meta[property=csp-nonce]`),c=s?.nonce||s?.getAttribute(`nonce`);function l(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:`fulfilled`,value:e}),e=>({status:`rejected`,reason:e}))))}o=l(i.map(i=>{if(i=t(i,a),i in n)return;n[i]=!0;let o=i.endsWith(`.css`),s=o?`[rel="stylesheet"]`:``;if(a)for(let e=r.length-1;e>=0;e--){let t=r[e];if(t.href===i&&(!o||t.rel===`stylesheet`))return}else if(document.querySelector(`link[href="${i}"]${s}`))return;let l=document.createElement(`link`);if(l.rel=o?`stylesheet`:e,o||(l.as=`script`),l.crossOrigin=``,l.href=i,c&&l.setAttribute(`nonce`,c),document.head.appendChild(l),o)return new Promise((e,t)=>{l.addEventListener(`load`,e),l.addEventListener(`error`,()=>t(Error(`Unable to preload CSS for ${i}`)))})}))}function s(e){let t=new Event(`vite:preloadError`,{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return o.then(e=>{for(let t of e||[])t.status===`rejected`&&s(t.reason);return r().catch(s)})};var i,a=`/models`,o=[`mnist_mlp`,`mnist_convnet`],s=document.getElementById(`model`),c=document.getElementById(`status`),l=document.getElementById(`timer`),u=e=>{throw c.innerHTML=`Error: ${e}`,Error(e)},d=async(e,t=``)=>{l.innerHTML=``;let n=performance.now(),r=await e(),i=(performance.now()-n).toFixed(1);return console.log(`${i} ms ${t}`),l.innerHTML=`${i} ms ${t}`,r},f=async()=>(navigator.gpu||u(`WebGPU not supported.`),await(await navigator.gpu.requestAdapter()).requestDevice({requiredFeatures:[`shader-f16`],powerPreference:`high-performance`})),p=async e=>{let t=`${a}/${e}/${e}.js`,n=`${a}/${e}/${e}.webgpu.safetensors`;try{c.innerHTML=`fetching model...`;let e=await f(),a=await fetch(t);if(!a.ok)throw Error(`Failed to fetch ${t}`);let o=await a.text(),s=new Blob([o],{type:`text/javascript`}),l=URL.createObjectURL(s),u=await r(()=>import(l),void 0,import.meta.url);URL.revokeObjectURL(l);let p=u.default;i=await d(()=>p.load(e,n),`(fetch + compilation)`),c.innerHTML=`ready to classify`}catch(e){u(e)}};const m=async e=>{i||u(`Net not loaded yet.`);let t=await d(()=>i(new Float32Array(e)),`(inference)`);return Array.from(new Float32Array(t[0]))},h=async()=>{for(let e of o){let t=document.createElement(`option`);t.value=e,t.innerHTML=e,s.appendChild(t)}s.addEventListener(`change`,e=>p(e.target.value)),await p(s.value)};function g(e,t){let n=document.createElement(`canvas`);n.width=28,n.height=28;let r=n.getContext(`2d`);r.imageSmoothingEnabled=!0,r.imageSmoothingQuality=`high`,r.drawImage(t,0,0,28,28);let i=e.canvas;e.imageSmoothingEnabled=!1,e.clearRect(0,0,i.width,i.height),e.drawImage(n,0,0,i.width,i.height);let{data:a}=r.getImageData(0,0,28,28),o=new Float32Array(784);for(let e=0;e<784;e++){let t=a[e*4+0],n=a[e*4+1],r=a[e*4+2];o[e]=(t+n+r)/3*2/255-1}return o}var _=document.getElementById(`draw`),v=document.getElementById(`clear`),y=document.getElementById(`preview`),b=document.getElementById(`pred`),x=document.getElementById(`conf`),S=document.getElementById(`run`),C=document.getElementById(`compileTime`),w=document.getElementById(`inferTime`),T=_.getContext(`2d`),E=y.getContext(`2d`);function D(){T.fillStyle=`black`,T.fillRect(0,0,_.width,_.height)}D();var O=!1,k=null,A={color:`white`,width:20,cap:`round`,join:`round`};function j(e,t){O=!0,k={x:e,y:t}}function M(e,t){O&&(T.strokeStyle=A.color,T.lineWidth=A.width,T.lineCap=A.cap,T.lineJoin=A.join,T.beginPath(),T.moveTo(k.x,k.y),T.lineTo(e,t),T.stroke(),k={x:e,y:t})}function N(){O=!1,k=null}_.addEventListener(`mousedown`,e=>{let t=_.getBoundingClientRect();j(e.clientX-t.left,e.clientY-t.top)}),_.addEventListener(`mousemove`,e=>{let t=_.getBoundingClientRect();M(e.clientX-t.left,e.clientY-t.top)}),window.addEventListener(`mouseup`,N),_.addEventListener(`touchstart`,e=>{let t=e.touches[0],n=_.getBoundingClientRect();j(t.clientX-n.left,t.clientY-n.top),e.preventDefault()},{passive:!1}),_.addEventListener(`touchmove`,e=>{let t=e.touches[0],n=_.getBoundingClientRect();M(t.clientX-n.left,t.clientY-n.top),e.preventDefault()},{passive:!1}),window.addEventListener(`touchend`,N),v.addEventListener(`click`,()=>{D(),E.clearRect(0,0,y.width,y.height),b.textContent=`—`,x.textContent=`—`,C.textContent=`—`,w.textContent=`—`}),await h(),S.addEventListener(`click`,()=>{let e=g(E,_);console.log(`input[0..9] = `,e.slice(0,10));let t=m(e);console.log(t)});</script>
    </head>
    <body class="min-h-screen bg-slate-950 text-slate-100">
        <div id="app" class="max-w-4xl mx-auto p-6 space-y-6">
            <h1 class="text-2xl font-semibold">MNIST</h1>

            <div class="rounded-2xl bg-slate-900 p-4 ring-1 ring-white/10 space-y-4">
                <div class="flex items-center gap-3">
                    <label for="model" class="text-sm text-slate-300">Model</label>
                    <select id="model" class="bg-slate-800 text-slate-100 text-sm rounded-md px-2 py-1 ring-1 ring-white/10">
                        <option value="mnist_mlp">mnist_mlp</option>
                        <option value="mnist_convnet">mnist_convnet</option>
                    </select>
                    <span id="status" class="text-xs text-slate-400 ml-auto">idle</span>
                    <span id="timer"  class="text-xs text-slate-400">—</span>
                </div>

                <div class="flex gap-6 items-start">
                    <div>
                        <canvas id="draw" width="280" height="280" class="rounded-xl bg-black ring-1 ring-white/10 cursor-crosshair"></canvas>
                        <div class="mt-3 flex gap-2">
                            <button id="clear" class="px-3 py-1.5 text-sm rounded-md bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10">Clear</button>
                            <button id="run" class="px-3 py-1.5 text-sm rounded-md bg-indigo-600 hover:bg-indigo-500">Run</button>
                        </div>
                    </div>

                    <div class="flex-1">
                        <div class="text-sm text-slate-300 mb-2">Preprocessed (28×28)</div>
                        <canvas id="preview" width="112" height="112" class="rounded-md bg-slate-900 ring-1 ring-white/10"></canvas>

                        <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
                            <div class="rounded-md bg-slate-900 ring-1 ring-white/10 p-2">
                                <div class="text-slate-400">Compilation</div>
                                <div id="compileTime" class="font-mono">—</div>
                            </div>
                            <div class="rounded-md bg-slate-900 ring-1 ring-white/10 p-2">
                                <div class="text-slate-400">Inference</div>
                                <div id="inferTime" class="font-mono">—</div>
                            </div>
                        </div>

                        <div class="mt-4 rounded-md bg-slate-900 ring-1 ring-white/10 p-3">
                            <div class="text-slate-400 text-sm">Prediction</div>
                            <div id="pred" class="text-3xl font-semibold mt-1">—</div>
                            <div id="conf" class="text-sm text-slate-400">—</div>
                        </div>
                    </div>
                </div>
            </div>

            <p class="text-xs text-slate-500">Draw white on black, then press “Run”.</p>
        </div>
    </body>
</html>
